name: Secure Platform Pipeline

on:
  push:
    branches: [master]

jobs:
  security-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write
      id-token: write   # REQUIRED for cosign keyless signing

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # --------------------
    # Python Setup
    # --------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Install dependencies
      run: pip install -r requirements.txt

    # --------------------
    # Dependency Scan
    # --------------------
    - name: Dependency Scan
      run: |
        pip install pip-audit
        pip-audit -f json -o audit.json || true

    # --------------------
    # SAST - SonarCloud
    # --------------------
    - name: Sonar Scan
      uses: sonarsource/sonarqube-scan-action@v2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: https://sonarcloud.io

    # --------------------
    # Build Docker Image
    # --------------------
    - name: Build Image
      run: docker build -t demo-secure-app:${{ github.sha }} .

    # --------------------
    # Trivy Scan
    # --------------------
    - name: Trivy Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: demo-secure-app:${{ github.sha }}
        format: table
        exit-code: '0'
        severity: HIGH,CRITICAL

    # --------------------
    # Run App for DAST
    # --------------------
    - name: Run container
      run: |
        docker run -d -p 8000:8000 demo-secure-app:${{ github.sha }}
        sleep 20

    - name: Fix workspace permissions
      run: sudo chmod -R 777 $GITHUB_WORKSPACE

    # --------------------
    # DAST - OWASP ZAP
    # --------------------
    - name: ZAP Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:8000'

    # --------------------
    # Docker Login
    # --------------------
    - name: Login DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_PASS }}

    # --------------------
    # Tag Image
    # --------------------
    - name: Tag Image
      run: |
        docker tag demo-secure-app:${{ github.sha }} \
        ${{ secrets.DOCKER_USER }}/secure-demo:${{ github.sha }}

    # --------------------
    # Push Image FIRST
    # --------------------
    - name: Push Image
      run: docker push ${{ secrets.DOCKER_USER }}/secure-demo:${{ github.sha }}

    # --------------------
    # Get Image Digest
    # --------------------
    - name: Get Image Digest
      id: digest
      run: |
        DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' \
        ${{ secrets.DOCKER_USER }}/secure-demo:${{ github.sha }})
        echo "digest=$DIGEST" >> $GITHUB_OUTPUT

    # --------------------
    # Install Cosign
    # --------------------
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3

    # --------------------
    # Sign Image (DIGEST)
    # --------------------
    - name: Sign Image
      run: cosign sign --yes ${{ steps.digest.outputs.digest }}